#!/bin/bash

exec > ${MODULE_STATE}/resolv.conf

(
    source <(redis-hgetall "module/${MODULE_ID}/module.env")
    echo "# generated by 15resolvconf"
    echo "search ${REALM,,}"
    echo "nameserver ${IPADDRESS}"
)

# XXX: get the list of the nsdc module instances Redis itself
for k in nsdc0 nsdc1 nsdc2 nsdc3; do
    if [[ ${MODULE_ID} == ${k} ]]; then
        continue
    fi
    (
        source <(redis-hgetall "module/${k}/module.env")
        if [[ -n ${IPADDRESS} ]]; then
            echo "nameserver ${IPADDRESS}"
        fi
    )
done
